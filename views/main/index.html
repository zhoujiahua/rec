{{ extend './../layout/tp_main.html' }}


{{block "style"}}
<link rel="stylesheet" href="/css/home.css">
{{/block}}

{{block "main"}}
<div class="home">
    <div class="layui-container">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend>
                <strong class="local-text" id="localCity"></strong>
                <span>租房信息</span>
            </legend>
        </fieldset>
        <div class="layui-row layui-col-space15" id="houseList">
            <!-- {{each house item }}
            <div class="layui-col-md6">
                <div class="house">
                    <div class="layui-panel house-item">
                        <div class="pic">
                            <img src="{{ item.imgr }}">
                        </div>
                        <div class="text">
                            <a href="{{ item.link }}" title="{{ item.title }}" class="layui-elip">
                                <strong>{{ item.type }}</strong>
                                <span>|</span>
                                <span>{{ item.title }}</span>
                            </a>
                            <dl>
                                <dd>
                                    <strong>商区：</strong>
                                    <span>{{ item.addres.business }}</span>
                                </dd>
                                <dd>
                                    <strong>房型：</strong>
                                    <span>{{ item.room }}</span>
                                    <span>-</span>
                                    <span>{{ item.area }}</span>
                                </dd>
                                <dd class="money">
                                    <strong>价格：</strong>
                                    <span>{{ item.money.price }}</span>
                                    <span>/</span>
                                    <span>{{ item.money.units }}</span>
                                </dd>
                                <dd>
                                    <strong>来源：</strong>
                                    <span>{{ item.source.type }}</span>
                                    <span>-</span>
                                    <span>{{ item.source.intro }}</span>
                                </dd>
                                <dd>
                                    <strong>距离：</strong>
                                    <span>{{ item.distance }}</span>
                                    <span>/km</span>
                                </dd>
                                <dd>
                                    <strong>地址：</strong>
                                    <span>{{ item.addres.district }}</span>
                                    <span>-</span>
                                    <span>{{ item.addres.route }}</span>
                                </dd>
                            </dl>
                            <div class="opt">
                                <button type="button" class="layui-btn layui-btn-xs layui-btn-danger"
                                    id="busBtn">公交路线</button>
                                <button type="button" class="layui-btn layui-btn-xs layui-btn-normal"
                                    id="carBtn">驾车路线</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {{/each}} -->
        </div>
        <div class="pages layui-row">
            <div id="page"></div>
        </div>
    </div>
</div>
{{/block}}

{{block "script"}}
<script>
    layui.use(['layer', 'laypage', 'flow'], function () {
        var layer = layui.layer,
            laypage = layui.laypage,
            flow = layui.flow,
            $ = layui.jquery;

        var cityInfo = localStorage.cityInfo,
            params = {
                wk: '',
                page: 1,
                curr: 1,
                limit: 20,
                sort: 'desc'
            };
        if (cityInfo) {
            cityInfo = JSON.parse(cityInfo);
            $("#localCity").text(cityInfo.city);
            params.wk = cityInfo.city;
            loadList(params);
        }

        function loadList(data) {
            $.ajax({
                type: "GET",
                url: "/api/spider/splist",
                data: data,
                dataType: "json",
                success: function (res) {
                    if (!res.success) return false;
                    setListHtml(res.data);
                    data.count = res.count;
                    data.jump = function (obj, first) {
                        if (first) return false;
                        loadList({
                            wk: data.wk,
                            page: obj.curr,
                            curr: obj.curr,
                            limit: obj.limit
                        })
                    }
                    if (res.count || res.count > data.limit) pageList(data);
                }
            });
        }

        function setListHtml(data) {
            var html = '';
            $.each(data, function (key, item) {
                html += `<div class="layui-col-md6"><div class="house"><div class="layui-panel house-item">
                         <div class="pic"><img layer-src="${item.imgr}" src="${item.imgr}"></div>
                         <div class="text">
                            <a href="${item.link}" title="${item.title}" target="_blank" class="layui-elip">
                                <strong>${ item.type }</strong><span>|</span><span>${ item.title }</span>
                            </a>
                            <dl>
                                <dd><strong>房型：</strong><span>${ item.room }</span></dd>
                                <dd class="money">
                                    <strong>价格：</strong><span>${ item.money.price }</span><span>/</span><span>${ item.money.units }</span>
                                </dd>
                                <dd>
                                    <strong>来源：</strong><span>${ item.source.type }</span><span>-</span>
                                    <span>${ item.source.info }</span><span>-</span><span>${ item.source.intro }</span>
                                </dd>
                                <dd>
                                    <strong>地址：</strong><span>${ item.infor.site }</span><span>-</span>
                                    <span>${ item.infor.housing }</span><span>-</span><span>${ item.infor.traffic }</span>
                                </dd>
                            </dl>
                            <div class="opt" data-address="${ item.infor.site }">
                                <button type="button" class="bus layui-btn layui-btn-xs layui-btn-danger" id="busBtn">查看地图</button>
                                <button type="button" class="look layui-btn layui-btn-xs layui-btn-normal" id="lookBtn">查看详情</button>
                            </div></div></div></div></div>`;
            });

            $("#houseList").html(html);

            // The screen load of image
            flow.lazyimg({
                elem: '#houseList .pic img',
                scrollElem: '#houseList'
            });

            // Photos Image
            layer.photos({
                photos: '.pic',
                anim: 4
            });

            $('.text a').on('click', function (e) {
                e.preventDefault();
                openRoomDetail($(this).attr('title'), $(this).attr('href'));
            })

            $('.bus').on('click', function () {
                var ads = $(this).parent('.opt');
                openRoomDetail(cityInfo.city + ads.data('address'), 'https://ditu.amap.com/dir');
            })

            $('.look').on('click', function () {
                var text = $(this).parents('.house').find('.text a');
                openRoomDetail(text.attr('title'), text.attr('href'));
            })
        }

        // Open layer page
        function openRoomDetail(title, url) {
            layer.open({
                title: title,
                area: ['96%', '92%'],
                type: 2,
                maxmin: true,
                content: url,
                btn: ['关闭']
            });
        }

        // laypage
        function pageList(pms) {
            laypage.render({
                theme: pms.theme || '#1E9FFF',
                elem: pms.elem || 'page',
                count: pms.count || 50,
                limit: pms.limit || 20,
                curr: pms.curr || 1,
                jump: pms.jump || function (obj) {
                    console.log(obj)
                }
            });
        }
    })
</script>
{{/block}}